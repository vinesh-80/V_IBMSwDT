<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Li-ion Battery Monitor</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    body {
        background: linear-gradient(to right, #ece9e6, #ffffff);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        padding: 20px;
    }
    h1 {
        text-align: center;
        margin-bottom: 30px;
        color: #007bff;
    }
    .card {
        border-radius: 15px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        transition: transform 0.2s;
    }
    .card:hover {
        transform: scale(1.02);
    }
    table {
        font-size: 1.1rem;
        font-weight: 500;
    }
    th, td {
        text-align: center;
        vertical-align: middle;
    }
    .soc-bar {
        height: 25px;
        border-radius: 12px;
        background: #ddd;
        overflow: hidden;
        margin-top: 5px;
    }
    .soc-fill {
        height: 100%;
        text-align: center;
        color: white;
        font-weight: bold;
        line-height: 25px;
    }
    canvas {
        margin-top: 25px;
    }
</style>
</head>
<body>
<h1>Li-ion Battery Monitoring Dashboard</h1>

<div class="container">
    <div class="card p-4">
        <table class="table table-striped table-hover">
            <thead class="table-primary">
                <tr>
                    <th>Voltage (V)</th>
                    <th>Charge Current (mAh)</th>
                    <th>Discharge Current (mAh)</th>
                    <th>Temperature (°C)</th>
                    <th>Humidity (%)</th>
                    <th>RUL (%)</th>
                    <th>Remaining Cycles</th>
                    <th>SOC (%)</th>
                </tr>
            </thead>
            <tbody id="batteryData">
                <tr>
                    <td colspan="8">Loading...</td>
                </tr>
            </tbody>
        </table>
        <div class="soc-bar">
            <div class="soc-fill bg-success" id="socFill" style="width:0%">0%</div>
        </div>
    </div>

    <!-- Charts -->
    <div class="card p-4">
        <h4 class="text-center text-primary mb-4">Battery Performance Graphs</h4>
        <canvas id="voltageChart"></canvas>
        <canvas id="currentChart"></canvas>
        <canvas id="socChart"></canvas>
        <canvas id="sohChart"></canvas>
        <canvas id="tempChart"></canvas>
        <canvas id="rulChart"></canvas>
    </div>
</div>

<script>
const THINGSPEAK_URL = "https://api.thingspeak.com/channels/670492/feeds.json?results=20";
const MAX_RUL_CYCLES = 5000;
const MAX_VOLTAGE = 11.7;

// Initialize Chart.js chart configs
let charts = {};

function createChart(ctx, label, yLabel, color) {
    return new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: label,
                data: [],
                borderColor: color,
                borderWidth: 2,
                fill: false,
                tension: 0.2
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: { title: { display: true, text: "Time" } },
                y: { title: { display: true, text: yLabel } }
            },
            plugins: {
                legend: { display: true, position: 'top' }
            }
        }
    });
}

function initializeCharts() {
    charts.voltage = createChart(document.getElementById('voltageChart'), "Voltage (V)", "Voltage (V)", "#007bff");
    charts.current = createChart(document.getElementById('currentChart'), "Current (mAh)", "Current (mAh)", "#ff5733");
    charts.soc = createChart(document.getElementById('socChart'), "SOC (%)", "SOC (%)", "#28a745");
    charts.soh = createChart(document.getElementById('sohChart'), "SOH (%)", "SOH (%)", "#8e44ad");
    charts.temp = createChart(document.getElementById('tempChart'), "Temperature (°C)", "Temperature (°C)", "#f39c12");
    charts.rul = createChart(document.getElementById('rulChart'), "RUL (%)", "RUL (%)", "#17a2b8");
}

async function fetchBatteryData() {
    try {
        const response = await fetch(THINGSPEAK_URL);
        const data = await response.json();
        const feeds = data.feeds;

        if (!feeds || feeds.length === 0) return;

        const latest = feeds[feeds.length - 1];

        // Latest values
        const voltage = parseFloat(latest.field1) || 0;
        const chargeCurrent = parseFloat(latest.field2) || 0;
        const dischargeCurrent = parseFloat(latest.field3) || 0;
        const temperature = parseFloat(latest.field4) || 0;
        const humidity = parseFloat(latest.field5) || 0;
        const rulPercent = parseFloat(latest.field6) || 0;

        const remainingCycles = Math.round((rulPercent / 100) * MAX_RUL_CYCLES);
        const soc = Math.min(Math.max((voltage / MAX_VOLTAGE) * 100, 0), 100);
        const soh = rulPercent; // SOH ~ RUL proxy

        // Update Table
        document.getElementById("batteryData").innerHTML = `
            <tr>
                <td>${voltage.toFixed(2)}</td>
                <td>${chargeCurrent.toFixed(2)}</td>
                <td>${dischargeCurrent.toFixed(2)}</td>
                <td>${temperature.toFixed(2)}</td>
                <td>${humidity.toFixed(2)}</td>
                <td>${rulPercent.toFixed(2)}</td>
                <td>${remainingCycles}</td>
                <td>${soc.toFixed(1)}</td>
            </tr>
        `;

        // Update SOC Bar
        const socFill = document.getElementById("socFill");
        socFill.style.width = soc.toFixed(1) + "%";
        socFill.textContent = soc.toFixed(1) + "%";
        if (soc > 80) socFill.className = "soc-fill bg-success";
        else if (soc > 50) socFill.className = "soc-fill bg-warning";
        else socFill.className = "soc-fill bg-danger";

        // Prepare data for charts
        const timestamps = feeds.map(f => new Date(f.created_at).toLocaleTimeString());
        const voltages = feeds.map(f => parseFloat(f.field1) || 0);
        const currents = feeds.map(f => parseFloat(f.field2) || 0);
        const socs = voltages.map(v => Math.min(Math.max((v / MAX_VOLTAGE) * 100, 0), 100));
        const sohs = feeds.map(f => parseFloat(f.field6) || 0);
        const temps = feeds.map(f => parseFloat(f.field4) || 0);
        const ruls = feeds.map(f => parseFloat(f.field6) || 0);

        // Update each chart
        updateChart(charts.voltage, timestamps, voltages);
        updateChart(charts.current, timestamps, currents);
        updateChart(charts.soc, timestamps, socs);
        updateChart(charts.soh, timestamps, sohs);
        updateChart(charts.temp, timestamps, temps);
        updateChart(charts.rul, timestamps, ruls);

    } catch (error) {
        console.error("Error fetching data:", error);
    }
}

function updateChart(chart, labels, data) {
    chart.data.labels = labels;
    chart.data.datasets[0].data = data;
    chart.update();
}

// Initialize
initializeCharts();
fetchBatteryData();
setInterval(fetchBatteryData, 5000);
</script>

</body>
</html>
